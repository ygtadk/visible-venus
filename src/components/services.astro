---
import { getLangFromUrl, useTranslations, useTranslatedPath } from "../i18n/utils";
import { ui, defaultLang } from "../i18n/ui";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

type UIKey = keyof typeof ui[typeof defaultLang];

const services: {
  image: string;
  titleKey: UIKey;
  descKey: UIKey;
}[] = [
  {
    image: "building-websites.svg",
    titleKey: "services.service1.title",
    descKey: "services.service1.desc",
  },
  {
    image: "server-cluster.svg",
    titleKey: "services.service2.title",
    descKey: "services.service2.desc",
  },
  {
    image: "maintenance.svg",
    titleKey: "services.service3.title",
    descKey: "services.service3.desc",
  },
  {
    image: "firewall.svg",
    titleKey: "services.service4.title",
    descKey: "services.service4.desc",
  },
  {
    image: "programming.svg",
    titleKey: "services.service5.title",
    descKey: "services.service5.desc",
  },
  {
    image: "clouds.svg",
    titleKey: "services.service6.title",
    descKey: "services.service6.desc",
  },
  {
    image: "online-connection.svg",
    titleKey: "services.service7.title",
    descKey: "services.service7.desc",
  }
];
---

<!-- Services Component -->
<section id="services" class="relative h-screen w-full bg-neutral-900 overflow-hidden">

  <!-- Progress Indicator -->
  <div class="absolute inset-0 z-50 pointer-events-none flex items-center justify-center">
    <div class="w-full max-w-7xl px-6 relative h-full">
      <div class="absolute left-6 top-1/2 -translate-y-1/2 hidden md:flex flex-col gap-4 pointer-events-auto">
        <!-- Intro Dot -->
        <div class="service-dot w-1 h-8 bg-neutral-700 rounded-full transition-all duration-300" data-index="0"></div>

        {services.map((_, index) => (
          <div 
            class="service-dot w-1 h-8 bg-neutral-700 rounded-full transition-all duration-300"
            data-index={index + 1}>
          </div>
        ))}
      </div>
    </div>
  </div>

  <!-- Slides -->
  <!-- Intro Slide -->
  <div class="service-panel absolute inset-0 w-full h-full bg-neutral-900 flex items-center justify-center" style="z-index: 1;">
    <!-- Title -->
    <div class="mx-auto mb-10 max-w-2xl text-center lg:mb-14">
      <h2 class="mb-6 text-center text-3xl font-bold tracking-widest text-green-400 uppercase">
        {t("services.title")}
      </h2>
      <p class="mt-1 text-white md:text-xl">
        {t("services.subtitle")}
      </p>
    </div>
    <!-- End Title -->
  </div>

  {services.map((service, index) => (
    <div 
      class="service-panel absolute inset-0 w-full h-full bg-neutral-900"
      style={`z-index: ${index + 2};`}>
      
      <div class="container mx-auto px-6 h-full flex items-center">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 lg:gap-12 items-center w-full">
          
          <!-- Left: Visual (Vector Graphic) -->
          <div class="service-visual lg:col-span-5 flex justify-center lg:justify-end opacity-0 translate-y-10">
            <div class="w-40 h-40 sm:w-64 sm:h-64 md:w-96 md:h-96 bg-neutral-800/50 rounded-3xl flex items-center justify-center relative overflow-hidden group border border-neutral-700/50 shadow-2xl">
               <!-- Image -->
                <div class="p-6 sm:p-10 text-green-400 transition-transform duration-700 group-hover:scale-110 group-hover:rotate-3">
                    <img src={`/${service.image}`} alt={t(service.titleKey)} class="w-full h-full object-contain" />
                </div>
               
               <!-- Decorative Glow -->
               <div class="absolute inset-0 bg-linear-to-tr from-green-500/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
               <div class="absolute -bottom-10 -right-10 w-40 h-40 bg-green-500/20 blur-[60px] rounded-full"></div>
            </div>
          </div>

          <!-- Right: Content -->
          <div class="service-content lg:col-span-7 text-center lg:text-left opacity-0 translate-y-10">
             <div class="w-full max-w-2xl mx-auto lg:mx-0 @container">
               <h2 class="font-bold text-white mb-4 lg:mb-6 leading-tight text-2xl sm:text-3xl md:text-4xl lg:text-[clamp(2rem,10cqw,3rem)]">
                 {t(service.titleKey)}
               </h2>
             </div>
             <p class="text-sm sm:text-base md:text-lg lg:text-xl text-neutral-400 leading-relaxed max-w-xl mx-auto lg:mx-0">
               {t(service.descKey)}
             </p>
             
             <!-- Optional: Learn More Link/Button -->
             {/* <div class="mt-8">
               <a href="#" class="inline-flex items-center gap-2 text-green-400 font-medium hover:text-green-300 transition-colors group">
                 <span>Daha Fazla</span>
                 <svg class="w-4 h-4 transition-transform group-hover:translate-x-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
               </a>
             </div> */}
          </div>

        </div>
      </div>

      <!-- Decorative Background (Optional, subtle) -->
      <div class="absolute inset-0 pointer-events-none opacity-5">
        <div class="absolute top-1/4 left-1/4 w-96 h-96 bg-white rounded-full blur-[128px]"></div>
      </div>
    </div>
  ))}
</section>
<!-- End Services Component -->

<!-- Services Component Script -->
<script>
  import { gsap } from "gsap";
  import { ScrollTrigger } from "gsap/ScrollTrigger";

  gsap.registerPlugin(ScrollTrigger);

  const wrapper = document.querySelector("#services");
  const panels = gsap.utils.toArray(".service-panel") as HTMLElement[];
  const dots = document.querySelectorAll(".service-dot");

  // Initial setup: 
  // First panel is visible. 
  // Others are positioned down (y: 100%) so they can slide up.
  // Actually, for "stacking" effect where they slide OVER each other:
  // Panel 0 is static.
  // Panel 1 slides up over Panel 0.
  // Panel 2 slides up over Panel 1.
  
  // We need to set initial state for panels 1 to N
  panels.forEach((panel, i) => {
    if (i !== 0) {
      gsap.set(panel, { yPercent: 100 });
    }
  });

  const tl = gsap.timeline({
    scrollTrigger: {
      trigger: wrapper,
      start: "top top",
      end: "+=" + (panels.length * 100) + "%", // Increased scroll distance for smoother animation
      pin: true,
      scrub: 1, // Smoother scrubbing
      // snap: 1 / (panels.length - 1), // Removed snapping to prevent freezing
    }
  });

  // Create animations for each panel transition
  panels.forEach((panel, i) => {
    if (i === 0) return; // Skip first panel

    // 1. Panel Slide Up
    tl.fromTo(panel, 
      { yPercent: 100, opacity: 0 },
      {
        yPercent: 0,
        opacity: 1,
        ease: "power2.inOut",
        duration: 1
      }
    );

    // 2. Visual Slide In (from left/bottom)
    tl.fromTo(panel.querySelector('.service-visual'), 
      { opacity: 0, x: -50, scale: 0.9 }, 
      { opacity: 1, x: 0, scale: 1, duration: 0.6, ease: "back.out(1.7)" }, 
      "<0.2"
    );

    // 3. Content Slide In (from right/bottom)
    tl.fromTo(panel.querySelector('.service-content'), 
      { opacity: 0, x: 50 }, 
      { opacity: 1, x: 0, duration: 0.6, ease: "power2.out" }, 
      "<0.1"
    );
  });

  // Initial content animation for the first panel
  const firstPanel = panels[0];
  gsap.to(firstPanel.querySelector('.service-visual'), {
    opacity: 1,
    y: 0,
    x: 0,
    duration: 1,
    ease: "power2.out",
    scrollTrigger: {
      trigger: wrapper,
      start: "top 60%",
    }
  });
  
  gsap.to(firstPanel.querySelector('.service-content'), {
    opacity: 1,
    y: 0,
    x: 0,
    duration: 1,
    delay: 0.2,
    ease: "power2.out",
    scrollTrigger: {
      trigger: wrapper,
      start: "top 60%",
    }
  });

  // Progress Indicator Logic
  // We can use a separate ScrollTrigger or update inside the timeline
  panels.forEach((_, i) => {
    ScrollTrigger.create({
      trigger: wrapper,
      start: () => "top top+=" + (i * window.innerHeight), // Approximate trigger points
      end: () => "top top+=" + ((i + 1) * window.innerHeight),
      // This logic is tricky with pinned scrub. 
      // Better to use the timeline's progress or just simple callbacks.
    });
  });

  // Simpler progress update:
  // Calculate active index based on scroll progress of the main trigger
  tl.eventCallback("onUpdate", () => {
    const progress = tl.progress();
    // progress goes 0 -> 1
    // We have panels.length segments? 
    // Actually we have (panels.length - 1) transitions.
    // Let's map progress to index.
    // 0.0 - 0.2 -> Index 0 (if 5 transitions)
    
    const totalTransitions = panels.length - 1;
    const index = Math.min(Math.floor(progress * panels.length), panels.length - 1);
    
    // Or slightly better mapping
    // If progress is 0, index 0.
    // If progress is > 0 but < 1/N, index 1 is coming in?
    
    // Let's just highlight based on which panel is "mostly" visible.
    // Since they stack, the highest index with yPercent < 100 is active?
    // Actually, the timeline animates them sequentially.
    
    // Let's use a simpler approach for dots:
    // Just highlight the one corresponding to the current "page"
    // Since we scrub, we can calculate it.
    
    const currentIndex = Math.round(progress * (panels.length - 1));
    
    dots.forEach((dot, i) => {
      if (i === currentIndex) {
        dot.classList.add("bg-green-400", "h-12");
        dot.classList.remove("bg-neutral-700", "h-8");
      } else {
        dot.classList.remove("bg-green-400", "h-12");
        dot.classList.add("bg-neutral-700", "h-8");
      }
    });
  });
  
  // Initialize first dot
  dots[0].classList.add("bg-green-400", "h-12");
  dots[0].classList.remove("bg-neutral-700", "h-8");

</script>
<!-- End Services Component Script -->
